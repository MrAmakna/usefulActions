---

name: Fetch RPM package and dependencies for Rhel8/Centos8 target
on:
  workflow_dispatch:
    inputs:
      targetHost:
        description: 'Target host'
        default: 'redhat/ubi8:8.4'
        required: true
      packageName:
        description: 'Package to fetch'
        required: true

jobs:
  FetchingOnTarget:
    runs-on: ubuntu-latest
    container:
      image: ${{ github.event.inputs.targetHost }}
    steps:
    - name: Install repositories
      run: |
        mkdir "${{ github.event.inputs.packageName }}"
        sed -ie "s/enabled=.*/enabled=0/" /etc/yum/pluginconf.d/subscription-manager.conf || true
        yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
        yum -y install https://dl.fedoraproject.org/pub/epel/epel-next-release-latest-8.noarch.rpm
        yum -y install yum-utils
        yum-config-manager --add-repo http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/
        yum-config-manager --add-repo http://mirror.centos.org/centos/8-stream/AppStream/x86_64/os/
        yum-config-manager --add-repo http://mirror.centos.org/centos/8-stream/PowerTools/x86_64/os/
        yum clean all
        yum makecache
        
    - name: Check Match in repositories and test dry installation
      run : |
        repoquery *${{ github.event.inputs.packageName }}*
        dnf info "${{ github.event.inputs.packageName }}"
        yes no | dnf install "${{ github.event.inputs.packageName }}" || true
        
    - name: Fetch package and dependencies
      run: |
        dnf download --resolve --downloaddir="${{ github.event.inputs.packageName }}/" ${{ github.event.inputs.packageName }}
        
    - name: Upload Archive
      uses: actions/upload-artifact@v3.1.0
      with:
        name: ${{ github.event.inputs.packageName }}
        path: ${{ github.event.inputs.packageName }}
        retention-days: 2
